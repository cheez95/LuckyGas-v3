# Story 3.4: Route Visualization Dashboard

**Epic**: 3 - Route Optimization System
**Story ID**: STORY-016
**Status**: In Progress
**Points**: 8
**Assignee**: James (Full Stack Developer)
**Track**: C - UI/UX Implementation

## Story Statement

As a dispatcher, I need to visualize routes on a map so that I can monitor and adjust deliveries.

## Acceptance Criteria

1. ✅ Interactive map with all routes displayed
2. ✅ Drag-and-drop route adjustment functionality
3. ✅ Real-time driver locations with live updates
4. ✅ Customer stop details on hover/click
5. ✅ Color coding by status/priority

## Dev Notes

### Previous Story Context
- Story 3.2 implemented VRP optimization with WebSocket progress tracking
- Backend optimization API endpoints available at `/api/v1/routes/optimize`
- WebSocket service ready for real-time updates
- Route models include polyline data for visualization

### Component Architecture
**Main Components**:
- `RouteMap` - Main map container with Google Maps
- `RouteLayer` - Displays optimized routes with polylines
- `DriverMarker` - Real-time driver position markers
- `StopMarker` - Customer delivery stop markers
- `RouteControl` - Route manipulation controls
- `RouteInfoPanel` - Details panel for selected routes/stops

### API Integration Points
- GET `/api/v1/routes?date={date}` - Fetch routes for visualization
- POST `/api/v1/routes/{id}/resequence` - Update stop sequence after drag-drop
- WebSocket `/ws/routes` - Real-time route updates
- WebSocket `/ws/drivers` - Live driver locations

### Google Maps Configuration
```typescript
// Required Google Maps libraries
libraries: ['places', 'geometry', 'drawing', 'visualization']

// Map options for Taiwan
defaultCenter: { lat: 25.0330, lng: 121.5654 } // Taipei
defaultZoom: 12
mapTypeControl: true
streetViewControl: false
```

### Real-time Update Architecture
1. WebSocket connection on component mount
2. Subscribe to route and driver channels
3. Update local state with incoming data
4. Debounce map re-renders for performance

### Color Coding Scheme
- **Green**: On-time/completed deliveries
- **Yellow**: Slight delay (5-15 min)
- **Orange**: Moderate delay (15-30 min)
- **Red**: Severe delay (>30 min)
- **Blue**: Not started/planned
- **Purple**: Priority/urgent deliveries

## Tasks / Subtasks

### Task 1: Setup Google Maps Integration (AC: 1)
- [ ] Install @react-google-maps/api package
- [ ] Create GoogleMapsProvider component
- [ ] Configure API key and libraries
- [ ] Setup map container with Taiwan defaults
- [ ] Add map controls and styling

### Task 2: Implement Route Visualization (AC: 1, 5)
- [ ] Create RouteMap main component
- [ ] Implement RouteLayer for polyline display
- [ ] Decode and render route polylines
- [ ] Apply color coding based on status
- [ ] Add route selection interactions

### Task 3: Build Stop Markers System (AC: 4, 5)
- [ ] Create StopMarker component
- [ ] Implement marker clustering for performance
- [ ] Add info windows with customer details
- [ ] Display delivery time windows
- [ ] Show package/cylinder information

### Task 4: Real-time Driver Tracking (AC: 3)
- [ ] Create DriverMarker component
- [ ] Implement WebSocket connection
- [ ] Handle driver location updates
- [ ] Add smooth marker animations
- [ ] Show driver info on click

### Task 5: Drag-and-Drop Route Adjustment (AC: 2)
- [ ] Implement draggable stop markers
- [ ] Create drop zones for reordering
- [ ] Calculate new route on drop
- [ ] Update backend via API
- [ ] Show preview during drag

### Task 6: Route Control Panel (AC: 1, 2, 4)
- [ ] Build RouteControl component
- [ ] Add route filters (driver, status, area)
- [ ] Implement route selection
- [ ] Create route statistics display
- [ ] Add optimization trigger button

### Task 7: Performance Optimization
- [ ] Implement marker clustering
- [ ] Add viewport-based rendering
- [ ] Optimize WebSocket subscriptions
- [ ] Debounce map updates
- [ ] Add loading states

### Task 8: Testing & Polish
- [ ] Unit tests for components
- [ ] Integration tests with API
- [ ] Test with 100+ stops
- [ ] Responsive design testing
- [ ] Cross-browser compatibility

## Testing Strategy

1. Component testing with React Testing Library
2. Visual regression tests for map states
3. Performance testing with large datasets
4. Real device testing for touch interactions
5. WebSocket connection reliability tests

## File Structure

```
frontend/src/
├── components/
│   └── RouteMap/
│       ├── index.tsx
│       ├── RouteMap.tsx
│       ├── RouteLayer.tsx
│       ├── DriverMarker.tsx
│       ├── StopMarker.tsx
│       ├── RouteControl.tsx
│       ├── RouteInfoPanel.tsx
│       ├── hooks/
│       │   ├── useRouteData.ts
│       │   ├── useDriverTracking.ts
│       │   └── useMapControls.ts
│       └── styles/
│           └── RouteMap.module.css
├── services/
│   └── maps/
│       ├── googleMapsConfig.ts
│       └── routeHelpers.ts
└── types/
    └── maps.types.ts
```

## Dev Agent Record

### Implementation Start
- [ ] Date/Time: 
- [ ] Agent: 
- [ ] Initial observations: 

### Completion Notes
- [ ] Date/Time: 
- [ ] Performance metrics: 
- [ ] Challenges encountered: 
- [ ] Browser compatibility notes: 

### Debug Log References
- [ ] Key debug entries: 

---
*Story created for parallel development on 2025-01-29*